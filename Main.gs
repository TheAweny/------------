// ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ====================

/**
 * –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —è—á–µ–µ–∫
 * @param {Event} e - –°–æ–±—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
 */
function onEdit(e) {
  try {
    const validator = new CellValidator(e);
    if (!validator.shouldProcess()) return;
    
    validator.validateAndProcess();
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    Utilities.sleep(100);
    updateAnalysis();
    
  } catch (error) {
    console.error(`–û—à–∏–±–∫–∞ –≤ onEdit: ${error.message}`);
    SpreadsheetApp.getUi().alert(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}`);
  }
}

/**
 * –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞
 */
function forceUpdateAnalysis() {
  updateAnalysis();
}

/**
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞
 */
function updateAnalysis() {
  try {
    const analyzer = new AromatherapyAnalyzer();
    analyzer.performAnalysis();
  } catch (error) {
    console.error(`–û—à–∏–±–∫–∞ –≤ updateAnalysis: ${error.message}`);
    SpreadsheetApp.getUi().alert(`${CONFIG.MESSAGES.ANALYSIS_ERROR} ${error.message}`);
  }
}

/**
 * –°–æ–∑–¥–∞–Ω–∏–µ –º–µ–Ω—é –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–∞–π–ª–∞
 */
function onOpen() {
  try {
    const ui = SpreadsheetApp.getUi();
    ui.createMenu('üåø –ê—Ä–æ–º–∞—Ç–µ—Ä–∞–ø–∏—è')
      .addItem('üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑', 'forceUpdateAnalysis')
      .addItem('üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', 'clearAllFormatting')
      .addItem('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É', 'runSystemTest')
      .addItem('‚ÑπÔ∏è –°–ø—Ä–∞–≤–∫–∞', 'showHelp')
      .addToUi();
  } catch (error) {
    console.error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–Ω—é: ${error.message}`);
  }
}

/**
 * –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
 */
function clearAllFormatting() {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    if (sheet.getName() === CONFIG.SHEETS.INPUT) {
      const range = sheet.getRange(2, CONFIG.COLUMNS.TROIKA + 1, sheet.getLastRow() - 1, 1);
      range.clearDataValidations();
      range.setBackground("white");
      SpreadsheetApp.getActiveSpreadsheet().toast("–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ", "–ì–æ—Ç–æ–≤–æ", 2);
    } else {
      SpreadsheetApp.getUi().alert("–§—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –ª–∏—Å—Ç–µ '–í–≤–æ–¥'");
    }
  } catch (error) {
    console.error(`–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.message}`);
  }
}

/**
 * –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
 */
function runSystemTest() {
  try {
    console.log('üß™ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞...');
    
    // –¢–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    const analyzer = new AromatherapyAnalyzer();
    console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞');
    
    // –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞—Ä—è
    analyzer.loadDictionary();
    console.log(`‚úÖ –°–ª–æ–≤–∞—Ä—å –∑–∞–≥—Ä—É–∂–µ–Ω: ${analyzer.dictionary.size} –∑–∞–ø–∏—Å–µ–π`);
    
    // –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—á–µ—Ç–∞–Ω–∏–π
    const combinationChecker = new CombinationChecker(analyzer.sheets.input);
    const combinations = combinationChecker.checkAllCombinations();
    console.log(`‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—á–µ—Ç–∞–Ω–∏–π: –Ω–∞–π–¥–µ–Ω–æ ${combinations.length} —Å–æ—á–µ—Ç–∞–Ω–∏–π`);
    
    SpreadsheetApp.getActiveSpreadsheet().toast("–°–∏—Å—Ç–µ–º–Ω—ã–π —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!", "–¢–µ—Å—Ç", 3);
    
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`);
    SpreadsheetApp.getUi().alert(`–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`);
  }
}

/**
 * –ü–æ–∫–∞–∑ —Å–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
 */
function showHelp() {
  const ui = SpreadsheetApp.getUi();
  const helpText = `
üåø –°–ò–°–¢–ï–ú–ê –ê–ù–ê–õ–ò–ó–ê –ê–†–û–ú–ê–¢–ï–†–ê–ü–ò–ò (–í–µ—Ä—Å–∏—è 2.0)

üìã –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò:
‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏–π "–¢—Ä–æ–π–∫–∞" –≤ –∑–æ–Ω–µ +++
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Å–æ—á–µ—Ç–∞–Ω–∏–π —ç—Ñ–∏—Ä–Ω—ã—Ö –º–∞—Å–µ–ª –ø–æ 830+ –ø—Ä–∞–≤–∏–ª–∞–º
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ –∏ –≤—ã–≤–æ–¥–∞–º–∏
‚Ä¢ –í—ã—è–≤–ª–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—á–Ω—ã—Ö –º–∞—Å–µ–ª –∏ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–µ–π

üìä –°–¢–†–£–ö–¢–£–†–ê –õ–ò–°–¢–û–í:
‚Ä¢ "–í–≤–æ–¥" ‚Äî –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
‚Ä¢ "–°–ª–æ–≤–∞—Ä—å" ‚Äî –±–∞–∑–∞ –º–∞—Å–µ–ª –∏ –∏—Ö —Å–≤–æ–π—Å—Ç–≤
‚Ä¢ "–ü–µ—Ä–µ–∫–æ—Å—ã" ‚Äî –∞–Ω–∞–ª–∏–∑ –¥–∏—Å–±–∞–ª–∞–Ω—Å–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
‚Ä¢ "–í—ã–≤–æ–¥" ‚Äî –∏—Ç–æ–≥–æ–≤—ã–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç

üöÄ –ö–ê–ö –ü–û–õ–¨–ó–û–í–ê–¢–¨–°–Ø:
1. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ª–∏—Å—Ç "–í–≤–æ–¥": –º–∞—Å–ª–æ, –∑–æ–Ω–∞, —Ç—Ä–æ–π–∫–∞
2. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏ –æ–±–Ω–æ–≤–∏—Ç –∞–Ω–∞–ª–∏–∑
3. –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –æ—Ç—á–µ—Ç—ã –Ω–∞ –ª–∏—Å—Ç–∞—Ö "–ü–µ—Ä–µ–∫–æ—Å—ã" –∏ "–í—ã–≤–æ–¥"
4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑" –≤ –º–µ–Ω—é

‚ú® –ù–û–í–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤
‚Ä¢ –Ø–≤–Ω—ã–π –≤—ã–≤–æ–¥ –≤—Å–µ—Ö —Å–æ—á–µ—Ç–∞–Ω–∏–π –±–µ–∑ —Å—Å—ã–ª–æ–∫
‚Ä¢ –¶–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö  
‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
‚Ä¢ –£–ª—É—á—à–µ–Ω–Ω–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –æ—Ç—á–µ—Ç–æ–≤

‚öôÔ∏è –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:
‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–¥–∞
‚Ä¢ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤
‚Ä¢ –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
  `;
  
  ui.alert('–°–ø—Ä–∞–≤–∫–∞ –ø–æ —Å–∏—Å—Ç–µ–º–µ', helpText, ui.ButtonSet.OK);
}

// ==================== –≠–ö–°–ü–û–†–¢ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ====================

/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
 */
function exportConfig() {
  console.log('üì§ –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã:');
  console.log(JSON.stringify(CONFIG, null, 2));
}

// END OF SCRIPT
